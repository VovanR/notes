<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Notes</title>

    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png?v=rMMKb0vWEj">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png?v=rMMKb0vWEj">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png?v=rMMKb0vWEj">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png?v=rMMKb0vWEj">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png?v=rMMKb0vWEj">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png?v=rMMKb0vWEj">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png?v=rMMKb0vWEj">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png?v=rMMKb0vWEj">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png?v=rMMKb0vWEj">
    <link rel="icon" type="image/png" href="/favicon-32x32.png?v=rMMKb0vWEj" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-194x194.png?v=rMMKb0vWEj" sizes="194x194">
    <link rel="icon" type="image/png" href="/favicon-96x96.png?v=rMMKb0vWEj" sizes="96x96">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png?v=rMMKb0vWEj" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-16x16.png?v=rMMKb0vWEj" sizes="16x16">
    <link rel="manifest" href="/manifest.json?v=rMMKb0vWEj">
    <link rel="mask-icon" href="/safari-pinned-tab.svg?v=rMMKb0vWEj" color="#5bbad5">
    <link rel="shortcut icon" href="/favicon.ico?v=rMMKb0vWEj">
    <meta name="msapplication-TileColor" content="#154489">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png?v=rMMKb0vWEj">
    <meta name="theme-color" content="#154489">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
    <link rel="stylesheet" href="index.css">
</head>
<body>

<div class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <span class="navbar-brand">
                Notes
            </span>
        </div>

        <p class="navbar-text">
            Under construction
        </p>

        <ul class="nav navbar-nav navbar-right">
            <li>
                <a href="https://github.com/VovanR/notes">
                    View on GitHub
                </a>
            </li>
        </ul>
    </div>
</div>

<div id="app"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-bootstrap/0.28.3/react-bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-router/2.0.0/ReactRouter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.2.0/highlight.min.js"></script>

<script type="text/babel" id="app-babel">
(function () {
    'use strict'

    const NOTES = [
        'AngularJS',
        'Backbone',
        'Bash',
        'Django',
        'Git',
        'JavaScript',
        'JS-TDD',
        'Node',
        'Python',
        'React',
        'RegExp',
        'Tmux',
        'TypeScript',
        'Vim'
    ]

    const {Grid, Row, Col, Panel, Nav, NavItem} = ReactBootstrap
    const {Router, Route, Link} = ReactRouter
    const markedRenderer = new marked.Renderer()

    markedRenderer.heading = (text, level) => {
        const escapedText = text.toLowerCase().replace(/[^\wА-Яа-я]+/g, '-')
        const id = `anchor-${escapedText}`
        return `<h${level} id="${id}"><a href="#${id}"></a>${text}</h${level}>`
    }

    class Menu extends React.Component {
        handleSelect(index) {
            this.props.onSelect(index)
        }

        render() {
            return (
                <Nav
                    bsStyle="pills"
                    stacked
                    activeKey={this.props.active}
                    onSelect={this.handleSelect.bind(this)}
                    >
                    {this.props.notes.map((note, index) => (
                        <NavItem
                            eventKey={index}
                            href={note.url}
                            >
                            {note.name}
                        </NavItem>
                    ))}
                </Nav>
            )
        }
    }

    class App extends React.Component {
        constructor() {
            super()
            let collection = (() => {
                return NOTES.map(note => {
                    return {
                        name: note,
                        url: new URL(`${note.toLowerCase()}.md`, location).href,
                        data: null
                    }
                })
            })()
            this.state = {
                notes: collection,
                active: 0
            }
            this.fetchCurrentNote()
        }

        fetchCurrentNote() {
            let current = this.state.notes[this.state.active]
            if (current.data) {
                return
            }
            fetch(current.url).then(response => {
                return response.text()
            }).then(data => {
                current.data = marked(
                    data,
                    {
                        sanitize: true,
                        gfm: true,
                        highlight: code => {
                            return hljs.highlightAuto(code).value
                        },
                        renderer: markedRenderer
                    }
                )
                this.setState()
            }).catch(() => {})
        }

        handleSelect(index) {
            this.setState({
                active: index
            }, () => {this.fetchCurrentNote()})
        }

        render() {
            let {notes, active: activeIndex} = this.state
            let active = notes[activeIndex]
            return (
                <Grid>
                    <Row>
                        <Col md={3}>
                            <Panel>
                                <Menu
                                    notes={notes}
                                    active={activeIndex}
                                    onSelect={this.handleSelect.bind(this)}
                                    />
                            </Panel>
                        </Col>
                        <Col md={9}>
                            <Panel>
                                {active.data ? (
                                    <div className="rendered-note" dangerouslySetInnerHTML={{__html: active.data}}/>
                                ) : null}
                            </Panel>
                        </Col>
                    </Row>
                </Grid>
            )
        }
    }

    ReactDOM.render(<App />, document.getElementById('app'))
})()
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.4.4/babel.min.js"></script>
<script>
(function () {
    var babelrc = {
        presets: [
            'es2015',
            'react'
        ]
    }
    var code = document.getElementById('app-babel').innerHTML
    var transpilledCode = Babel.transform(code, babelrc).code

    document.write(`<script>${transpilledCode}<\/script>`)
})()
</script>

</body>
</html>
