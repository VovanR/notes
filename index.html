<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Notes</title>


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
    <style type="text/css">
        .h1, .h2, .h3, h1, h2, h3 {
            margin-top: 50px;
        }
        .h1, h1 {
            margin-top: 0;
        }
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            position: relative;
        }
        a[href^="#anchor-"] {
            position: absolute;
            right: 100%;
            cursor: pointer;
            padding: 0 8px;
            background-color: #fff;
            font-family: serif;
            color: #999;
        }
        a[href^="#anchor-"]::before {
            display: inline-block;
            content: '#';
        }

        pre {
            background-color: #fff;
            border-color: #ddd;
            border-radius: 0;
        }
        .panel {
            border: none;
            -webkit-box-shadow: none;
            box-shadow: none;
        }
        .navbar-default {
            border: none;
        }
        .nav-pills > li > a {
            border-radius: 0;
        }
        .rendered-note {
        }
        .rendered-note ul,
        .rendered-note ol {
            padding: 0;
        }
    </style>
</head>
<body>

<div class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <span class="navbar-brand">Notes</span>
        </div>
        <p class="navbar-text">Under construction</p>
        <ul class="nav navbar-nav navbar-right">
            <li>
                <a href="https://github.com/VovanR/notes">View on GitHub</a>
            </li>
        </ul>
    </div>
</div>

<div id="app">
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.6/react.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.6/react-dom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-bootstrap/0.28.1/react-bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-router/1.0.0/ReactRouter.min.js"></script>
<script src="https://npmcdn.com/history/umd/History.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
<script type="text/babel">
(function () {
    'use strict'

    const NOTES = ['Bash', 'Django', 'Git', 'JS-TDD', 'Node', 'React', 'Tmux', 'Vim']

    const {Grid, Row, Col, Panel, Nav, NavItem} = ReactBootstrap
    const {Router, Route, Link} = ReactRouter
    const {createHistory, useBasename} = History
    const markedRenderer = new marked.Renderer()

    markedRenderer.heading = (text, level) => {
        const escapedText = text.toLowerCase().replace(/[^\wА-Яа-я]+/g, '-')
        const id = `anchor-${escapedText}`
        return `<h${level} id="${id}"><a href="#${id}"></a>${text}</h${level}>`
    }

    class Menu extends React.Component {
        handleSelect(id, href) {
            console.log(id, href);
            this.props.onSelect(id)
            history.pushState(null, href)
        }

        render() {
            const notes = this.props.notes
            let items = []

            return (
                <Nav
                    bsStyle="pills"
                    stacked
                    activeKey={this.props.active}
                    onSelect={this.handleSelect.bind(this)}
                >
                    {Object.keys(notes).map((note, index) => (
                        <Link
                            to={notes[note].href}
                        >
                            {notes[note].name}
                        </Link>
                    ))}
                    {Object.keys(notes).map((note, index) => (
                        <NavItem
                            key={index}
                            eventKey={notes[note].id}
                            href={notes[note].href}
                        >
                            {notes[note].name}
                        </NavItem>
                    ))}
                </Nav>
            )
        }
    }

    const Notes = function () {
        this._init();
    }
    Notes.prototype = {
        _init: function () {
            let items = {}
            NOTES.forEach(note => {
                const id = note.toLowerCase()
                items[id] = {
                    id: id,
                    name: note,
                    href: `/${id}`,
                    url: new URL(`${id}.md`, location).href,
                    data: null
                }
            })
            this._notes = items
        },

        getNotes: function () {
            return this._notes
        },

        getNote: function (noteId) {
            let note = this._getNote(noteId)
            if (note.data) {
                return new Promise((resolve) => {resolve(note)})
            } else {
                return this._fetchNote(noteId)
            }
        },

        _getNote: function (noteId) {
            return this._notes[noteId]
        },

        _fetchNote: function (noteId) {
            let note = this._getNote(noteId)

            return fetch(note.url)
                .then(response => {
                    return response.text()
                })
                .then(data => {
                    note.data = marked(
                        data,
                        {
                            sanitize: true,
                            gfm: true,
                            highlight: code => {
                                return hljs.highlightAuto(code).value
                            },
                            renderer: markedRenderer
                        }
                    )
                    return note
                })
                .catch(() => {})
        }
    }
    const notes = new Notes();

    class App extends React.Component {
        constructor() {
            super()
            this.state = {
                notes: notes.getNotes(),
                active: 'bash'
            }
        }

        handleSelect(id) {
            this.setState({
                active: id
            }, () => {
                console.log('goto', id);
            })
        }

        render() {
            let {notes, active} = this.state
            return (
                <Grid>
                    <Row>
                        <Col md={3}>
                            <Panel>
                                <Menu
                                    notes={notes}
                                    active={active}
                                    onSelect={this.handleSelect.bind(this)}
                                />
                            </Panel>
                        </Col>
                        <Col md={9}>
                            <Panel>
                                {this.props.children}
                            </Panel>
                        </Col>
                    </Row>
                </Grid>
            )
        }
    }

    class Note extends React.Component {
        constructor() {
            super()
            this.state = {
                note: {}
            }
        }
        componentDidMount() {
            notes.getNote(this.props.params.id).then(note => {
                this.setState({note: note})
            })
        }
        render() {
            return (
                <div>
                    {this.state.note.data ? (
                        <div className="rendered-note" dangerouslySetInnerHTML={{__html: this.state.note.data}} />
                    ) : null}
                </div>
            )
        }
    }

    const history = useBasename(createHistory)({
        basename: '/notes'
    })

    ReactDOM.render((
        <Router history={history}>
            <Route path="/" component={App}>
                <Route path=":id" component={Note} />
            </Route>
        </Router>
    ), document.getElementById('app'))
})()
</script>
</body>
</html>
